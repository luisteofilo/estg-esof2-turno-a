@page "/gamereplays"
@using Frontend.Helpers
@attribute [StreamRendering]
@rendermode InteractiveServer
@inject ApiHelper ApiHelper

<PageTitle>Game Replays</PageTitle>

<h1>Game Replays</h1>

<p>This component demonstrates uploading and displaying videos from Endpoint to DB.</p>

@if (!string.IsNullOrEmpty(uploadError))
{
    <div class="alert alert-danger">
        @uploadError
    </div>
}
@if (!string.IsNullOrEmpty(uploadResult))
{
    <div class="alert alert-success">
        @uploadResult
    </div>
}

<div class="form-container">
    <label for="videoTitle" class="form-label">Title</label>
    <input type="text" class="form-control" id="videoTitle" @bind="videoTitle" />
    
    <label for="videoFile" class="form-label">Select Video</label>
    <InputFile id="videoFile" class="form-control-file" OnChange="HandleFileSelected" />

    <button class="btn btn-primary" @onclick="UploadFile" disabled="@isUploading">Upload</button>
</div>

@if (isUploading)
{
    <div class="spinner-container">
        <div class="spinner-border" role="status"></div>
        <p class="loading-message">Uploading video, please wait...</p>
    </div>
}

@if (_gameReplays == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else if (!_gameReplays.Any())
{
    <p>
        <em>No game replays found.</em>
    </p>
}
else
{
    <div class="video-container">
        @foreach (var replay in _gameReplays)
        {
            <div class="video-item">
                <h3>@replay.Title</h3>
                <video width="640" height="480" controls>
                    <source src="data:video/mp4;base64,@Convert.ToBase64String(replay.VideoData)" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <p>Uploaded on: @replay.UploadDate.ToString("yyyy-MM-dd")</p>
            </div>
        }
    </div>
}

@code {
    private string videoTitle = string.Empty;
    private IBrowserFile? selectedFile;
    private List<GameReplay>? _gameReplays;
    private string? uploadError;
    private string? uploadResult;
    private bool isUploading = false;

    private async Task UploadFile()
    {
        uploadError = null; // Reset any previous errors
        uploadResult = null; // Reset previous result
        isUploading = true; // Set uploading state to true

        if (selectedFile != null && !string.IsNullOrEmpty(videoTitle))
        {
            try
            {
                Console.WriteLine($"Selected file: {selectedFile.Name}, size: {selectedFile.Size}");
                Console.WriteLine("Preparing to upload file...");
                
                var content = new MultipartFormDataContent();
                using var memoryStream = new MemoryStream();
                await selectedFile.OpenReadStream(maxAllowedSize: 1073741824).CopyToAsync(memoryStream); // 1GB limit
                
                Console.WriteLine($"MemoryStream length after reading file: {memoryStream.Length}");

                var fileContent = new ByteArrayContent(memoryStream.ToArray());
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);
                
                // Log the Content-Type header
                Console.WriteLine($"File Content-Type set to: {fileContent.Headers.ContentType}");
                
                content.Add(fileContent, "VideoFile", selectedFile.Name);
                content.Add(new StringContent(videoTitle), "Title");

                var response = await ApiHelper.PostToApiAsync("gamereplays", content);
                if (response.IsSuccessStatusCode)
                {
                    uploadResult = "Video uploaded successfully!";
                    Console.WriteLine("Video uploaded successfully!");
                    await LoadGameReplays();
                }
                else
                {
                    uploadError = $"Failed to upload video. Status code: {response.StatusCode}";
                    Console.WriteLine($"Failed to upload video. Status code: {response.StatusCode}");
                }
            }
            catch (Exception ex)
            {
                HandleException(ex);
                Console.WriteLine($"Exception during upload: {ex.Message}");
            }
        }
        else
        {
            uploadError = "Please select a video file to upload and enter a title.";
            Console.WriteLine("Video file or title is missing.");
        }

        isUploading = false; // Set uploading state to false
    }

    private async Task LoadGameReplays()
    {
        try
        {
            _gameReplays = await ApiHelper.GetFromApiAsync<List<GameReplay>>("gamereplays");
        }
        catch (Exception ex)
        {
            HandleException(ex);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadGameReplays();
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        Console.WriteLine($"Selected file: {selectedFile.Name}, size: {selectedFile.Size}");
    }

    private void HandleException(Exception ex)
    {
        uploadError = $"An error occurred: {ex.Message}";
        Console.WriteLine($"Exception: {ex.Message}");
    }

    public class GameReplay
    {
        public Guid Id { get; set; }
        public string Title { get; set; }
        public DateTime UploadDate { get; set; }
        public byte[] VideoData { get; set; }
        public string FilePath { get; set; }
    }
}
